<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Image/Video Uploader</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .card { margin-top: 20px; }
    #fileList .list-group-item { display: flex; justify-content: space-between; align-items: center; }
    .media-preview { max-width: 100px; max-height: 60px; object-fit: cover; margin-right: 10px; }
  </style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="card-body">
      <h3 class="card-title">Upload Image or Video</h3>
      <div class="mb-3">
        <input class="form-control" type="file" id="fileInput">
      </div>
      <button id="uploadBtn" class="btn btn-primary">Upload</button>
      <span id="status" class="ms-3"></span>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h4 class="card-title">Uploaded Files</h4>
      <ul id="fileList" class="list-group list-group-flush"></ul>
    </div>
  </div>
</div>

<!-- Supabase JS -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const supabaseUrl = 'https://mblnepfihcxbjkiviltm.supabase.co'
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ibG5lcGZpaGN4YmpraXZpbHRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2NDg0NDIsImV4cCI6MjA2NTIyNDQ0Mn0.j5tV_DPirVfu9A4QpofzT6LkVyJrNldCUHkBomEfMyU'
  const bucket = 'media'
  const supabase = createClient(supabaseUrl, supabaseKey)

  const fileInput = document.getElementById('fileInput')
  const uploadBtn = document.getElementById('uploadBtn')
  const status = document.getElementById('status')
  const fileList = document.getElementById('fileList')

  // Load files on startup
  window.addEventListener('DOMContentLoaded', loadFiles)

  uploadBtn.addEventListener('click', async () => {
    const file = fileInput.files[0]
    if (!file) {
      alert('Please select a file.')
      return
    }
    const fileName = `${Date.now()}-${file.name}`
    status.textContent = 'Uploading...'

    const { data, error } = await supabase.storage
      .from(bucket)
      .upload(fileName, file)

    if (error) {
      status.textContent = 'Upload failed'
      console.error(error)
    } else {
      status.textContent = 'Upload successful'
      fileInput.value = ''
      loadFiles()
    }
  })

  async function loadFiles() {
    fileList.innerHTML = ''
    const { data, error } = await supabase.storage.from(bucket).list('', { limit: 100 })
    if (error) {
      console.error('Error listing files', error)
      return
    }
    data.forEach(file => {
      const li = document.createElement('li')
      li.className = 'list-group-item'

      // Preview element
      let preview = ''
      const url = supabase.storage.from(bucket).getPublicUrl(file.name).data.publicUrl
      if (file.name.match(/\.(jpg|jpeg|png|gif)$/i)) {
        preview = `<img src="${url}" class="media-preview rounded" />`
      } else if (file.name.match(/\.(mp4|webm|ogg)$/i)) {
        preview = `<video src="${url}" class="media-preview rounded" muted />` 
      }

      li.innerHTML = `
        <div class="d-flex align-items-center">
          ${preview}
          <span>${file.name}</span>
        </div>
        <div>
          <button class="btn btn-sm btn-outline-secondary me-1" onclick="copyLink('${url}')">Copy Link</button>
          <a href="${url}" target="_blank" class="btn btn-sm btn-outline-primary me-1">View</a>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteFile('${file.name}')">Delete</button>
        </div>
      `
      fileList.appendChild(li)
    })
  }

  window.copyLink = (url) => {
    navigator.clipboard.writeText(url).then(() => {
      alert('Link copied to clipboard!')
    })
  }

  window.deleteFile = async (fileName) => {
    if (!confirm(`Delete ${fileName}?`)) return
    const { error } = await supabase.storage.from(bucket).remove([fileName])
    if (error) {
      alert('Error deleting file')
      console.error(error)
    } else {
      loadFiles()
    }
  }
</script>
<!-- Bootstrap JS (optional for components) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
