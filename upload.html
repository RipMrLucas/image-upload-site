<input id="file" type="file" accept="image/*,video/*" />
<button id="uploadBtn">Upload</button>

<div style="margin-top:10px">
  <progress id="prog" value="0" max="100" style="width:100%"></progress>
  <div id="status"></div>
</div>

<hr />

<div id="gallery" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:12px;"></div>

<script>
const API_BASE = "https://imagehost-upload-api.pashka20003333.workers.dev";

const fileEl = document.getElementById("file");
const uploadBtn = document.getElementById("uploadBtn");
const prog = document.getElementById("prog");
const statusEl = document.getElementById("status");
const galleryEl = document.getElementById("gallery");

uploadBtn.addEventListener("click", async () => {
  const file = fileEl.files?.[0];
  if (!file) return setStatus("Pick a file first.");

  prog.value = 0;
  setStatus("Requesting upload URL...");

  // 1) Ask Worker for presigned URL
  const signRes = await fetch(`${API_BASE}/sign`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      filename: file.name,
      contentType: file.type || "application/octet-stream",
      size: file.size
    })
  });

  if (!signRes.ok) {
    const err = await safeJson(signRes);
    return setStatus(`Sign failed: ${signRes.status} ${JSON.stringify(err)}`);
  }

  const { uploadUrl, publicUrl } = await signRes.json();

  // 2) Upload directly to R2 with progress
  setStatus("Uploading to R2...");
  await putWithProgress(uploadUrl, file, file.type, (pct) => {
    prog.value = pct;
    setStatus(`Uploading... ${pct}%`);
  });

  // 3) Show result + refresh gallery
  setStatus(`Done! Public URL: ${publicUrl}`);
  fileEl.value = "";
  await loadGallery();
});

async function loadGallery() {
  const res = await fetch(`${API_BASE}/list`);
  if (!res.ok) return setStatus("Failed to load gallery.");
  const data = await res.json();

  galleryEl.innerHTML = "";
  for (const f of data.files) {
    const url = f.publicUrl;
    const isVideo = /\.(mp4|webm|mov)$/i.test(f.key);

    const card = document.createElement("div");
    card.style.border = "1px solid #333";
    card.style.borderRadius = "10px";
    card.style.padding = "8px";
    card.style.background = "#111";

    const a = document.createElement("a");
    a.href = url;
    a.target = "_blank";
    a.rel = "noopener noreferrer";
    a.style.color = "#7aa2ff";
    a.style.wordBreak = "break-all";
    a.textContent = f.key.split("/").pop();

    if (isVideo) {
      const v = document.createElement("video");
      v.src = url;
      v.controls = true;
      v.muted = true;
      v.playsInline = true;
      v.style.width = "100%";
      v.style.borderRadius = "8px";
      card.appendChild(v);
    } else {
      const img = document.createElement("img");
      img.src = url;
      img.alt = f.key;
      img.loading = "lazy";
      img.style.width = "100%";
      img.style.borderRadius = "8px";
      card.appendChild(img);
    }

    const meta = document.createElement("div");
    meta.style.marginTop = "6px";
    meta.style.fontSize = "12px";
    meta.style.opacity = "0.8";
    meta.textContent = `${(f.size/1024/1024).toFixed(2)} MB`;

    card.appendChild(meta);
    card.appendChild(a);
    galleryEl.appendChild(card);
  }
}

// Upload with progress using XHR (fetch doesn't expose upload progress)
function putWithProgress(url, file, contentType, onProgress) {
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open("PUT", url, true);
    if (contentType) xhr.setRequestHeader("Content-Type", contentType);

    xhr.upload.onprogress = (e) => {
      if (!e.lengthComputable) return;
      const pct = Math.round((e.loaded / e.total) * 100);
      onProgress(pct);
    };

    xhr.onload = () => {
      if (xhr.status >= 200 && xhr.status < 300) resolve();
      else reject(new Error(`PUT failed: ${xhr.status} ${xhr.responseText}`));
    };

    xhr.onerror = () => reject(new Error("Network error during upload"));
    xhr.send(file);
  });
}

function setStatus(msg) {
  statusEl.textContent = msg;
}

async function safeJson(res) {
  try { return await res.json(); } catch { return await res.text(); }
}

// Load gallery on page load
loadGallery();
</script>
